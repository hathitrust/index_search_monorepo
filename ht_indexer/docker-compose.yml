version: "3"
services:
  document_retriever:
    container_name: document_retriever
    image: document_generator
    command: [ "python", "document_retriever_service/full_text_search_retriever_service.py", "--query", "id:012407877" ]
    volumes:
      - ../tmp:/tmp:rm
      - ../sample_data/sdr1/obj:/sdr1/obj
    ports:
      - "8081:8081"
    environment:
      - SOLR_URL=http://solr-sdr-catalog:9033/solr/#/catalog/
      - MYSQL_HOST=mudslide.umdl.umich.edu
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASS=${MYSQL_PASS}
      - MYSQL_DATABASE=ht
      - SDR_DIR=/sdr1/obj
    depends_on:
      solr-sdr-catalog:
        condition: service_healthy
  solr-lss-dev:
    image: ghcr.io/hathitrust/full-text-search-embedded_zoo:example-8.11
    container_name: solr-lss-dev
    ports:
      - "8983:8983"
    volumes:
      - solr_data:/var/solr/data
    command: solr-foreground -c
    healthcheck:
      test: [ "CMD-SHELL", "solr healthcheck -c core-x" ]
      interval: 5s
      timeout: 10s
      start_period: 30s
      retries: 5
  solr-sdr-catalog:
    container_name: solr-sdr-catalog
    image: ghcr.io/hathitrust/catalog-solr-sample
    healthcheck:
      test: [ "CMD", "/usr/bin/curl", "-s", "-f", "http://localhost:9033/solr/catalog/admin/ping" ]
      interval: 5s
      timeout: 10s
      start_period: 30s
      retries: 5
    ports:
      - "9033:9033"
    expose:
      - 9033
  test:
    container_name: indexing_test
    build: .
    volumes:
      - .:/app
      - ../tmp:/tmp
    command: [ "pytest" ]
    depends_on:
      solr-sdr-catalog:
        condition: service_healthy
  document_indexer:
    container_name: document_indexer
    image: document_generator
    command: [ "python", "document_indexer_service/document_indexer_service.py", "--solr_indexing_api", "http://solr-lss-dev:8983/solr/#/core-x/" ]
    volumes:
      - ../tmp:/tmp:rm
    ports:
      - "8082:8082"
    depends_on:
      solr-lss-dev:
        condition: service_healthy
volumes:
  solr_data:

